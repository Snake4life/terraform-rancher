- name: Bootstrap Rancher server and cluster
  hosts: all
  connection: local
  gather_facts: false

  tasks:
    - name: Provision Rancher server 
      terraform:
        project_path: 01-rancher-server/
        state: present
      register: tf_rancher
      tags:
        - rancher

    - name: Provision cluster
      terraform:
        project_path: 02-cluster/
        state: present
      register: tf_cluster
      tags:
        - cluster

    - name: Basic deployment
      terraform:
        project_path: 03-cluster-base/
        state: present
      tags:
        - base

    - import_role: 
        name: cert-manager
      environment:
        K8S_AUTH_KUBECONFIG: "{{ playbook_dir }}/02-cluster/outputs/kubeconfig"
      vars:
        cert_mananger_version: '0.11.0'
      tags:
        - cert-manager

    - name: Ingress configuration
      terraform:
        project_path: 04-cluster-ingress/
        state: present
      tags:
        - ingress
